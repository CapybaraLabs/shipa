buildscript {
	configurations.classpath {
		resolutionStrategy.activateDependencyLocking()
	}
}

plugins {
	// Apply the org.jetbrains.kotlin.jvm Plugin to add support for Kotlin.
	alias(libs.plugins.kotlin.jvm)
	alias(libs.plugins.versions)
	alias(libs.plugins.spring.boot)
}

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(gradle.ext.theJavaVersion)
		vendor = JvmVendorSpec.ADOPTIUM
	}
	consistentResolution {
		useCompileClasspathVersions()
	}
}

tasks.withType(JavaCompile) {
	dependsOn(processResources)
	options.encoding = "UTF-8"
	options.release.set(gradle.ext.theJavaVersion.toInteger())
	options.compilerArgs << "-Xlint:unchecked" << "-Xlint:deprecation" << "-Xmaxerrs" << "10000" << "-Xdiags:verbose"
	options.incremental = true
}
tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
	kotlinOptions.jvmTarget = gradle.ext.theJavaVersion
}

repositories {
	// Use Maven Central for resolving dependencies.
	mavenCentral()
}

dependencies {
	implementation platform(libs.kotlin.bom)
	implementation platform(libs.spring.boot.bom)

	implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
	implementation "org.springframework.boot:spring-boot-starter"
}

dependencyLocking {
	lockAllConfigurations()
}

// ./gradlew resolveAndLockAll --write-locks
task resolveAndLockAll {
	doFirst {
		assert gradle.startParameter.writeDependencyLocks
	}
	doLast {
		configurations.all {
			resolutionStrategy {
				componentSelection properReleasesOnly()
			}
		}
		configurations
				.findAll { it.canBeResolved }
				.each { it.resolve() }
	}
}

springBoot {
	mainClass = "dev.capybaralabs.shipa.LauncherKt"
}

jar {
	onlyIf { false }
}

tasks.named("dependencyUpdates").configure {
	resolutionStrategy {
		componentSelection properReleasesOnly()
	}
	checkConstraints = true
	checkBuildEnvironmentConstraints = true
	gradleReleaseChannel = "current"
}


static def properReleasesOnly() {
	return { rules ->
		rules.all { ComponentSelection selection ->
			if (isNonStable(selection.candidate.version) && !isNonStable(selection.currentVersion)) {
				reject('Release candidate')
			}
		}
	}
}

static def isNonStable(String version) {
	def stableKeyword = ['RELEASE', 'FINAL', 'GA'].any { it -> version.toUpperCase().contains(it) }
	def regex = /^[0-9,.v-]+(-r)?$/
	return !stableKeyword && !(version ==~ regex)
}
